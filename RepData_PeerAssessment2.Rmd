---
title: "RepData Project 2: The Impact of Weather Events on Property and Crop Damage in the US"
output: 
  html_document:
    keep_md: true
---


# Synopsis
******
It's well known that severe weather events can have a major impact on municipal well-being; if a tornado touches down in your city, you're screwed. This report extracts the primary weather types contributing to agricultural, physical and health damage in the US between 1950 and 2011.

(describe data source)
Data processing was assisted by use of a reference document: "ï¿¼NATIONAL WEATHER SERVICE INSTRUCTION 10-1605", included here as the file "repdata-peer2_doc-pd01016005curr.pdf".
(describe events types, without listing them)
(describe the discovery of the event types that are the major contributors to health and damage figures)

All supporting data files, documents and source code can be found at: https://github.com/sheldon-white/RepData_PeerAssessment2

# Challenges
* Unclear data description: There isn't a "proper" databook supplied for this dataset. The included PDF file provides general descriptions of the data but in the end it was necessary to make assumptions in interpreting the data. 
* Damage exponents: These columns (PROPDMGEXP and CROPDMGEXP) represent multipliers for the dollar amounts represnted by the PROPDMG (property damage) and CROPDMG (crop damage) columns. In the end, only "H", "K", "M", "B" were used because their meaning was fairly clear (after internet research) and seemed to be consistent with a sampling of the REMARKS column descriptions. The rows containing numeric PROPDMGEXP and CROPDMGEXP values were ultimately rejected, because inspection of their REMARKS values showed many descriptions that had no relation to the calculated damage values. For instance, damage exponents of 12 or 14 (which imply catastrophic dollar amounts) could not be reconciled with the corresponding event descriptions.
* Irregular EVTYPE values: EVTYPE values not matching the 48 official categories were mapped to these categories through inspection, trial and error, and creation of pattern-matching rules. The set of patterns listed here results in the assignment of %99.97 of the data to these 48 values.
* Inflation
Damage values are inflation-adjusted to 2011 values using conversion factors extracted from data compied at the Oregon State Political Science department:
http://oregonstate.edu/cla/polisci/sites/default/files/faculty-research/sahr/inflation-conversion/excel/infcf17742014.xls.
Values A(210) - A(271) and T(210) - T(271) were extracted from this Excel file to create inflationFactors.csv. These numbers represent the number of old dollars equivalent to a 2011 dollar. (For example: 0.107 1950 dollars == one 2011 dollar.) The reported weather damage values are divided by these conversion values to obtain the equivalent 2011 damage values.


# Data Processing
******

Load the raw storm data
```{r data-loading}
library(stringr)
library(plyr)
library(reshape)
library(ggplot2)
#stormData = read.csv(bzfile("repdata-data-StormData.csv.bz2"))
```
Only retain the rows that contain damage, injuries or fatalities. We can also discard most of the columns.
```{r initial-data-filtering}
#damageData = stormData[stormData$FATALITIES > 0 | stormData$INJURIES > 0 | stormData$PROPDMG > 0 | stormData$CROPDMG > 0,]
damageData = read.csv("meaningful.csv")
damageData = damageData[,c("FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP", "BGN_DATE", "EVTYPE")]

damageData = damageData[damageData$PROPDMGEXP %in% c("H", "M", "K", "B") | damageData$CROPDMGEXP %in% c("H", "M", "K", "B"),]

```
Load the standard set of event types, convert to patterns for exact matching. For convenience, all patterns are matched using regular expressions in a single pass.
```{r prepare-event-types}
evTypes = read.csv("eventtypes.csv", header = FALSE)
evTypes$V1 = str_trim(tolower(evTypes$V1))
evTypes$evtype = evTypes$V1
colnames(evTypes) = c("pattern", "evtype")
evTypes$pattern = paste("^", evTypes$pattern, "$", sep="")
```

Add the additional matching regular expressions. These are pairs of (pattern, standard-event) strings.
```{r prepare-matching-patterns}
rules = c(  
    "(typhoon|hurricane)", "hurricane (typhoon)",
    "(wall cloud|micoburst|microburst|downburst|turbulence|thunder|tstm)", "thunderstorm wind",
    "chill", "extreme cold/wind chill",  
    "wind", "high wind",   
    "fog and cold temperatures", "freezing fog",
    "fog", "dense fog",
    "gustnado", "high wind",
    "(tornado|torndao)", "tornado",
    "(ligntning|lighting)", "lightning",
    "(heavy|hvy|excessive|torrential|record).+(rain|rainfall|rainstorm|precipatation|precipitation)", "heavy rain",
    "(shower|rainstorm|rain damage|prolonged rain)", "heavy rain",
    "mixed precipitation", "heavy rain",   
    "(heavy|hvy|excessive|torrential|record).+snow", "heavy snow",
    "snow", "winter weather",
    "hail", "hail",
    "(sleet|freezing)", "sleet",
    "(swell|surf)", "high surf",
    "spout", "waterspout",
    "(coastal storm|surge)", "storm surge/tide",
    "(extreme|severe|heavy|hvy|excessive|torrential|record|unusual).+cold", "extreme cold/wind chill",
    "hypothermia", "extreme cold/wind chill",
    "cold", "cold/wind chill",
    "low temperature", "cold/wind chill",
    "(frost|freeze)", "frost/freeze",
    "(tide)", "storm surge/tide",
    "(wave| seas)", "high surf",
    "fire", "wildfire",
    "wint", "winter weather",
    "(hot|warm)", "heat",
    "(slide|mud|landslump)", "debris flow",
    "avalance", "avalanche",
    "flood", "flash flood",
    "(high water|fld|rapidly rising water)", "flood",
    "dust", "dust storm",
    "tropical storm", "tropical storm",
    "(ice|icy|glaze)", "frost/freeze"
)

ruleset = data.frame(matrix(rules, ncol=2, byrow=TRUE))
colnames(ruleset) = c("pattern", "evtype")
allRules = rbind(evTypes, ruleset)
```

Then assign all possible records into the official categories.
```{r assign-all-events}
damageData$normalizedEvtype = str_trim(tolower(damageData$EVTYPE))
damageData$event = NA
a = apply(allRules, 1, function(row) {
    pattern = row[1]   
    evtype = row[2]
    matches = grepl(pattern, damageData$normalizedEvtype) & is.na(damageData$event)  
    damageData[matches, "event"] <<- evtype
})
```
Load the inflation adjustment factors; add inflation data to the damageData table.
```{r attach-inflaction-factors}
inflationFactors = read.csv("inflationFactors.csv", header = FALSE)
colnames(inflationFactors) = c("year", "factor")
class(inflationFactors$year) = "integer"

inflation = function(y) {
    inflationFactors$factor[inflationFactors$year == y]
}

damageData$year = strptime(damageData$BGN_DATE, "%m/%d/%Y %H:%M:%S")$year + 1900
class(damageData$year) = "integer"
damageData$inflationFactor = as.numeric(lapply(damageData$year, inflation))
```
Now convert the damage cost records into a useable form, scaling them with the damage exponents and the inflation factor.
```{r convert-damage-vaules}
damageData$PROPDMGEXP = toupper(damageData$PROPDMGEXP)
damageData$CROPDMGEXP = toupper(damageData$CROPDMGEXP)


damageData$propMultiplier = 1
damageData$propMultiplier[damageData$PROPDMGEXP == "H"] = 100
damageData$propMultiplier[damageData$PROPDMGEXP == "K"] = 1000
damageData$propMultiplier[damageData$PROPDMGEXP == "M"] = 1000000
damageData$propMultiplier[damageData$PROPDMGEXP == "B"] = 1000000000
damageData$cropMultiplier = 1
damageData$cropMultiplier[damageData$CROPDMGEXP == "H"] = 100
damageData$cropMultiplier[damageData$CROPDMGEXP == "K"] = 1000
damageData$cropMultiplier[damageData$CROPDMGEXP == "M"] = 1000000
damageData$cropMultiplier[damageData$CROPDMGEXP == "B"] = 1000000000

damageData$propDmgDollars = damageData$propMultiplier * damageData$PROPDMG / damageData$inflationFactor
damageData$cropDmgDollars = damageData$cropMultiplier * damageData$CROPDMG / damageData$inflationFactor
```
Extract the minimum set of columns for data visualization, reshape the data into a final format. We separate damage values from health values at this point.
```{r reshape-data}
damage = damageData[!is.na(damageData$event), c("FATALITIES", "INJURIES", "propDmgDollars", "cropDmgDollars", "event")]
damage$event = factor(damage$event)

totals = ddply(damage, .(event), summarize,
               injuries = sum(INJURIES),
               fatalities = sum(FATALITIES),
               cropDamage = sum(cropDmgDollars),
               propDamage = sum(propDmgDollars))
```
We calculate the relative contributions of each event type to it's category. We will discard all event types with little impact.
```{r extract-percentages}

totals$propDamagePct = 100 * totals$propDamage / sum(totals$propDamage)
totals$cropDamagePct = 100 * totals$cropDamage / sum(totals$cropDamage)
totals$injuriesPct = 100 * totals$injuries / sum(totals$injuries)
totals$fatalitiesPct = 100 * totals$fatalities / sum(totals$fatalities)
totals = ddply(damage, .(event), summarize,
               injuries = sum(INJURIES),
               fatalities = sum(FATALITIES),
               cropDamage = sum(cropDmgDollars),
               propDamage = sum(propDmgDollars))
totals$propDamagePct = 100 * totals$propDamage / sum(totals$propDamage)
totals$cropDamagePct = 100 * totals$cropDamage / sum(totals$cropDamage)
totals$injuriesPct = 100 * totals$injuries / sum(totals$injuries)
totals$fatalitiesPct = 100 * totals$fatalities / sum(totals$fatalities)

damageEvents = totals[,c("event","propDamage", "propDamagePct", "cropDamage", "cropDamagePct")]
healthEvents = totals[,c("event","injuries", "injuriesPct", "fatalities", "fatalitiesPct")]

```
Gather some final statistics about the data processing.
```{r display-summary-statistics}
uncategorized = damageData[is.na(damageData$event),]
message("uncategorized row count: ", nrow(uncategorized))
message("uncategorized damage: ", sum(uncategorized$propDmgDollars) + sum(uncategorized$cropDmgDollars))
message("categorized damage: ", sum(damage$propDmgDollars) + sum(damage$cropDmgDollars))
```

# Results
******
We only retain events that are a significant contributor (> %1) to the damage and health totals. 
```{r create-plots}
damageEvents = totals[,c("event","propDamage", "propDamagePct", "cropDamage", "cropDamagePct")]
healthEvents = totals[,c("event","injuries", "injuriesPct", "fatalities", "fatalitiesPct")]
worstDamageEvents = damageEvents[damageEvents$propDamagePct > 1 & damageEvents$cropDamagePct > 1, c("event","propDamage", "cropDamage")]
colnames(worstDamageEvents)[2:3] = c("Property Damage", "Crop Damage")
worstHealthEvents = healthEvents[healthEvents$injuriesPct > 1 & healthEvents$fatalitiesPct > 1, c("event","injuries", "fatalities")]
colnames(worstHealthEvents)[2:3] = c("Injuries", "Fatalities")

damageCollated = melt(worstDamageEvents, id=c("event"))
healthCollated = melt(worstHealthEvents, id=c("event"))
colnames(damageCollated)[2] = "category"
colnames(healthCollated)[2] = "category"
damageCollated$value = damageCollated$value / 1000000

ggplot(damageCollated, aes(event, value)) +
    geom_bar(aes(fill = category), position = "dodge", stat = "identity") + coord_flip() +
    xlab("Event Type") + ylab("Total Damage (Millons of Dollars)")
ggplot(healthCollated, aes(event, value)) +
    geom_bar(aes(fill = category), position = "dodge", stat="identity") + coord_flip() +
    xlab("Event Type") + ylab("Number of Affected People")
```
